<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>OncoPro | Suite Oncol√≥gica</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    :root {
      /* Colores Profesionales Dark Mode */
      --bg-body: #0f172a;
      --bg-panel: #1e293b;
      --border: rgba(255,255,255,0.08);
      
      --text-main: #f8fafc;
      --text-muted: #94a3b8;
      
      --accent: #0ea5e9;       /* Azul Principal */
      --success: #22c55e;      /* Verde √âxito */
      --warning: #f59e0b;      /* Naranja Alerta */
      --danger: #ef4444;       /* Rojo Error */
      
      /* WhatsApp */
      --wa-bg: #e5ddd5;
      --wa-header: #008069;
      --wa-in: #ffffff;
      --wa-out: #d9fdd3;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; outline: none; }
    body { background: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; }

    /* --- LAYOUT --- */
    .app-layout { display: grid; grid-template-columns: 260px 1fr 350px; width: 100%; height: 100%; transition: 0.3s; }

    /* 1. SIDEBAR */
    .sidebar { 
      background: #020617; border-right: 1px solid var(--border); padding: 1.5rem; 
      display: flex; flex-direction: column; gap: 2rem; z-index: 50; 
      box-shadow: 2px 0 20px rgba(0,0,0,0.2);
    }
    .brand { font-size: 1.4rem; font-weight: 800; color: var(--accent); display: flex; align-items: center; gap: 12px; letter-spacing: -0.5px; }
    
    .nav-menu { display: flex; flex-direction: column; gap: 8px; }
    .nav-btn {
      background: transparent; border: none; width: 100%; padding: 12px 16px; text-align: left; color: var(--text-muted);
      cursor: pointer; border-radius: 10px; font-size: 0.95rem; font-weight: 500; display: flex; align-items: center; gap: 12px; transition: all 0.2s ease;
    }
    .nav-btn:hover { background: rgba(255,255,255,0.05); color: #fff; transform: translateX(4px); }
    .nav-btn.active { background: rgba(14, 165, 233, 0.15); color: #fff; border-left: 3px solid var(--accent); }
    .nav-btn i { width: 20px; text-align: center; }

    /* 2. MAIN CONTENT */
    .main-content { position: relative; background: radial-gradient(circle at top left, #1e293b, #0f172a); overflow: hidden; }
    
    .view-section {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; padding: 2.5rem; overflow-y: auto;
      display: none; flex-direction: column; gap: 1.5rem; 
      opacity: 0; transform: translateY(10px); transition: opacity 0.4s ease, transform 0.4s ease;
    }
    .view-section.active { display: flex; opacity: 1; transform: translateY(0); }

    /* Cards */
    .card { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 16px; padding: 1.5rem; box-shadow: 0 4px 20px rgba(0,0,0,0.1); transition: 0.3s; }
    .card:hover { border-color: rgba(255,255,255,0.15); }

    /* Workflow Visual */
    .workflow-container { overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; }
    .workflow-track { display: flex; justify-content: space-between; margin-top: 15px; position: relative; min-width: 500px; padding: 0 10px; }
    .track-bg { position: absolute; top: 12px; left: 0; right: 0; height: 4px; background: #334155; z-index: 1; border-radius: 2px; }
    .track-fill { position: absolute; top: 12px; left: 0; height: 4px; background: var(--accent); z-index: 1; border-radius: 2px; width: 0%; transition: width 0.5s ease; }
    
    .step { position: relative; z-index: 2; display: flex; flex-direction: column; align-items: center; gap: 8px; min-width: 60px; cursor: default; }
    .step-dot { 
      width: 28px; height: 28px; background: #1e293b; border-radius: 50%; border: 4px solid #334155; 
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
    }
    .step.active .step-dot { background: var(--success); border-color: var(--success); box-shadow: 0 0 15px rgba(34,197,94,0.4); transform: scale(1.1); }
    .step.current .step-dot { background: var(--accent); border-color: var(--accent); transform: scale(1.3); box-shadow: 0 0 20px rgba(14,165,233,0.5); }
    .step-label { font-size: 0.7rem; text-transform: uppercase; color: var(--text-muted); font-weight: 700; transition: 0.3s; }
    .step.current .step-label { color: #fff; }

    /* Action Deck */
    .action-deck { display: flex; justify-content: space-between; align-items: center; background: linear-gradient(90deg, #1e293b, #24344e); }
    
    .btn-action {
      background: #f8fafc; color: #0f172a; border: none; padding: 14px 28px; border-radius: 12px; font-weight: 700; cursor: pointer;
      display: flex; align-items: center; gap: 10px; transition: all 0.2s ease; font-size: 0.95rem;
      box-shadow: 0 4px 15px rgba(255,255,255,0.05);
    }
    .btn-action:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(255,255,255,0.15); background: #fff; }
    .btn-action:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
    .btn-action i { transition: 0.3s; }
    .btn-action:hover i { transform: translateX(3px); }

    /* 3. PHONE SIMULATOR */
    .phone-zone { background: #000; border-left: 1px solid var(--border); padding: 40px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
    .iphone { 
      width: 320px; height: 650px; background: #111; border-radius: 50px; border: 6px solid #2d2d2d; 
      overflow: hidden; position: relative; display: flex; flex-direction: column; 
      box-shadow: 0 30px 60px rgba(0,0,0,0.6); 
    }
    .notch { position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 140px; height: 28px; background: #000; border-radius: 0 0 16px 16px; z-index: 20; }
    .screen { flex: 1; background: var(--wa-bg); display: flex; flex-direction: column; background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png"); background-blend-mode: overlay; background-size: 300px; }
    
    /* WhatsApp UI */
    .wa-header { background: var(--wa-header); padding: 45px 15px 12px; color: white; display: flex; align-items: center; gap: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 10; }
    .chat-area { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; scroll-behavior: smooth; }
    
    .msg { 
      max-width: 85%; padding: 8px 12px; border-radius: 12px; font-size: 13.5px; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.15); color: #111; margin-bottom: 2px; line-height: 1.4;
      animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; opacity: 0; transform: scale(0.8);
    }
    @keyframes popIn { to { opacity: 1; transform: scale(1); } }

    .msg.in { background: var(--wa-in); align-self: flex-start; border-top-left-radius: 0; }
    .msg.out { background: var(--wa-out); align-self: flex-end; border-top-right-radius: 0; }
    .msg-time { font-size: 10px; color: #666; text-align: right; margin-top: 2px; display: flex; justify-content: flex-end; align-items: center; gap: 3px; }
    .check-read { color: #53bdeb; font-size: 14px; }

    /* TOAST NOTIFICATIONS */
    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
    .toast {
      background: rgba(30, 41, 59, 0.95); border-left: 4px solid var(--accent); color: #fff; padding: 15px 20px; border-radius: 8px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3); min-width: 300px; display: flex; align-items: center; gap: 15px;
      animation: slideInRight 0.3s forwards; backdrop-filter: blur(10px);
    }
    @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes fadeOut { to { opacity: 0; transform: translateY(-10px); } }

    /* TRACKING LIST */
    .track-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
    .track-col { display: flex; flex-direction: column; gap: 1rem; }
    .t-item { display: flex; gap: 15px; position: relative; padding-bottom: 30px; }
    .t-line { position: absolute; left: 15px; top: 30px; bottom: 0; width: 2px; background: #334155; }
    .t-item:last-child .t-line { display: none; }
    .t-icon { 
      width: 32px; height: 32px; border-radius: 50%; background: #0f172a; border: 2px solid #334155; 
      display: grid; place-items: center; z-index: 2; font-size: 0.8rem; color: var(--text-muted); flex-shrink: 0;
    }
    .t-item.done .t-icon { border-color: var(--success); color: var(--success); background: rgba(34,197,94,0.1); }
    .t-content { background: rgba(255,255,255,0.03); padding: 12px; border-radius: 8px; flex: 1; border: 1px solid transparent; transition: 0.3s; }
    .t-item.done .t-content { border-color: rgba(34,197,94,0.2); }
    
    /* Responsive Mobile */
    @media (max-width: 1024px) {
      .app-layout { grid-template-columns: 1fr; grid-template-rows: auto 1fr auto; display: block; overflow-y: auto; }
      .sidebar { flex-direction: row; justify-content: space-between; align-items: center; position: sticky; top: 0; padding: 10px 20px; overflow-x: auto; }
      .nav-menu { flex-direction: row; }
      .nav-btn { width: auto; padding: 8px 15px; font-size: 0.8rem; border-left: none; border-bottom: 3px solid transparent; border-radius: 20px; }
      .nav-btn.active { border-left: none; border-bottom-color: var(--accent); background: rgba(14,165,233,0.1); }
      
      .view-section { position: relative; height: auto; overflow: visible; padding: 1.5rem; }
      .phone-zone { height: auto; padding: 50px 20px; border-top: 1px solid var(--border); border-left: none; background: #050505; }
      .iphone { width: 100%; max-width: 360px; height: 600px; }
      .track-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <div class="toast-container" id="toast-area"></div>

  <div class="app-layout">
    
    <nav class="sidebar">
      <div class="brand"><i class="fa-solid fa-dna"></i> OncoPro <span style="font-size:0.7rem; color:#fff; background:var(--accent); padding:2px 6px; border-radius:4px; margin-left:5px;">v1.0</span></div>
      
      <div class="nav-menu">
        <button class="nav-btn active" onclick="switchView('ops', this)">
          <i class="fa-solid fa-layer-group"></i> Operaciones
        </button>
        <button class="nav-btn" onclick="switchView('tracking', this)">
          <i class="fa-solid fa-truck-fast"></i> Rastreo
        </button>
        <button class="nav-btn" onclick="switchView('medical', this)">
          <i class="fa-solid fa-user-doctor"></i> M√©dicos
        </button>
        <button class="nav-btn" onclick="switchView('finance', this)">
          <i class="fa-solid fa-chart-pie"></i> Finanzas
        </button>
      </div>

      <div class="card" style="margin-top: auto; padding: 12px; display: flex; align-items: center; gap: 10px; border: 1px solid #334155;">
        <div style="width:35px; height:35px; background: #334155; border-radius:50%; display:grid; place-items:center;">üë©‚Äçüíº</div>
        <div>
          <div style="font-size: 0.85rem; font-weight: 600;">Lupita (Ops)</div>
          <div style="font-size: 0.7rem; color: var(--success);">‚óè En l√≠nea</div>
        </div>
      </div>
    </nav>

    <main class="main-content">

      <section id="view-ops" class="view-section active">
        <div style="display: flex; justify-content: space-between; align-items: flex-end;">
          <div>
            <h2 style="font-weight: 800; font-size: 1.8rem; margin-bottom: 5px;">Caso #AQ-2025-001</h2>
            <p style="color: var(--text-muted);">Paciente: <strong style="color: #fff;">Laura M√©ndez</strong> | Esquema: <span id="regimen-lbl" style="background:rgba(255,255,255,0.1); padding:2px 6px; border-radius:4px;">--</span></p>
          </div>
          <div style="text-align: right;">
            <div style="font-size: 2.2rem; font-weight: 800; color: var(--accent);" id="progress-pct">0%</div>
          </div>
        </div>

        <div class="card workflow-container">
          <div class="workflow-track">
            <div class="track-bg"></div>
            <div class="track-fill" id="track-fill"></div>
            
            <div class="step current" id="s0"><div class="step-dot"></div><div class="step-label">Intake</div></div>
            <div class="step" id="s1"><div class="step-dot"></div><div class="step-label">An√°lisis</div></div>
            <div class="step" id="s2"><div class="step-dot"></div><div class="step-label">Cotizar</div></div>
            <div class="step" id="s3"><div class="step-dot"></div><div class="step-label">Dr. VoBo</div></div>
            <div class="step" id="s4"><div class="step-dot"></div><div class="step-label">Paciente</div></div>
            <div class="step" id="s5"><div class="step-dot"></div><div class="step-label">Pago</div></div>
            <div class="step" id="s6"><div class="step-dot"></div><div class="step-label">Agenda</div></div>
          </div>
        </div>

        <div class="card action-deck">
          <div>
            <h3 id="act-title" style="margin-bottom: 5px;">Nueva Solicitud</h3>
            <p style="color: var(--text-muted); font-size: 0.9rem;" id="act-desc">Paciente inicia contacto. Requiere esquema.</p>
          </div>
          <button class="btn-action" id="btn-advance" onclick="advanceWorkflow()">
            <i class="fa-solid fa-play"></i> <span id="btn-txt">Solicitar Esquema</span>
          </button>
        </div>

        <div>
          <h4 style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;">Bit√°cora del Sistema (ROMI)</h4>
          <div class="card" style="background:#000; font-family:monospace; color:#a3e635; height:150px; overflow-y:auto; font-size:0.85rem;" id="sys-log">
            <div>> [System] OncoPro v4.0 inicializado.</div>
          </div>
        </div>
      </section>

      <section id="view-tracking" class="view-section">
        <h2>üì¶ Rastreo de Insumos</h2>
        <div class="track-grid">
          
          <div class="card track-col">
            <div style="display:flex; align-items:center; gap:10px; border-bottom:1px solid #334155; padding-bottom:15px; margin-bottom:10px;">
              <i class="fa-solid fa-building" style="color:var(--accent); font-size:1.2rem;"></i>
              <div><h4 style="margin:0;">SAFE (Externo)</h4><small style="color:var(--text-muted);">Oncol√≥gicos</small></div>
            </div>
            <div id="track-safe-list">
              <div class="t-item done">
                <div class="t-line"></div><div class="t-icon"><i class="fa-solid fa-power-off"></i></div>
                <div class="t-content" style="padding:8px;"><small>Sistema Listo</small></div>
              </div>
            </div>
          </div>

          <div class="card track-col">
            <div style="display:flex; align-items:center; gap:10px; border-bottom:1px solid #334155; padding-bottom:15px; margin-bottom:10px;">
              <i class="fa-solid fa-boxes-stacked" style="color:var(--warning); font-size:1.2rem;"></i>
              <div><h4 style="margin:0;">Almac√©n AQUA</h4><small style="color:var(--text-muted);">Insumos Internos</small></div>
            </div>
            <div id="track-aqua-list">
              <div class="t-item done">
                <div class="t-line"></div><div class="t-icon"><i class="fa-solid fa-power-off"></i></div>
                <div class="t-content" style="padding:8px;"><small>Sistema Listo</small></div>
              </div>
            </div>
          </div>

        </div>
      </section>

      <section id="view-medical" class="view-section">
        <h2>üë®‚Äç‚öïÔ∏è Validaci√≥n M√©dica</h2>
        <div class="card">
          <table>
            <thead><tr><th>M√©dico</th><th>Rol</th><th>C√©dula</th><th>Estado del Caso</th></tr></thead>
            <tbody>
              <tr>
                <td style="font-weight:600;">Dr. Iv√°n P√©rez</td>
                <td>Oncolog√≠a M√©dica</td>
                <td>1234567 <i class="fa-solid fa-circle-check" style="color:var(--accent)"></i></td>
                <td><span id="md-status" style="background:rgba(245,158,11,0.2); color:#f59e0b; padding:4px 10px; border-radius:20px; font-size:0.75rem; font-weight:700;">PENDIENTE</span></td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <section id="view-finance" class="view-section">
        <h2>üí∞ An√°lisis Financiero</h2>
        <div class="track-grid">
          <div class="card" style="height:300px; display:flex; justify-content:center;">
             <canvas id="finChart"></canvas>
          </div>
          <div class="card">
            <h3>Desglose de Costos</h3>
            <p style="font-size:0.8rem; color:var(--text-muted); margin-bottom:15px;">Calculado autom√°ticamente con reglas de negocio (15% Comisi√≥n).</p>
            <table style="font-size:0.95rem;">
              <tr><td style="color:var(--text-muted);">Costo SAFE (Base)</td><td style="text-align:right; font-weight:600;" id="f-safe">$0.00</td></tr>
              <tr><td style="color:var(--text-muted);">Insumos AQUA</td><td style="text-align:right; font-weight:600;" id="f-aqua">$0.00</td></tr>
              <tr><td style="color:var(--accent);">Comisi√≥n (15%)</td><td style="text-align:right; font-weight:700; color:var(--accent);" id="f-comm">$0.00</td></tr>
              <tr style="border-top:1px solid #fff;"><td style="padding-top:15px;">TOTAL</td><td style="text-align:right; padding-top:15px; font-size:1.2rem; font-weight:800;" id="f-total">$0.00</td></tr>
            </table>
          </div>
        </div>
      </section>

    </main>

    <aside class="phone-zone">
      <div style="color:#666; font-size:0.75rem; text-transform:uppercase; letter-spacing:1px; margin-bottom:15px;">Vista Paciente (WhatsApp)</div>
      <div class="iphone">
        <div class="notch"></div>
        <div class="screen">
          <div class="wa-header">
            <div style="width:38px; height:38px; background:#fff; border-radius:50%; color:#008069; display:grid; place-items:center; font-weight:bold; font-size:14px;">AQ</div>
            <div style="color:white; margin-left:10px;">
              <div style="font-weight:600; font-size:15px;">OncoPro Atenci√≥n</div>
              <div style="font-size:11px; opacity:0.9;">Cuenta Oficial de Empresa</div>
            </div>
          </div>
          <div class="chat-area" id="chat">
            <div style="text-align:center; margin:10px 0;"><span style="background:rgba(254,243,199,0.9); padding:4px 8px; border-radius:4px; font-size:10px; color:#333; box-shadow:0 1px 1px rgba(0,0,0,0.1);">üîí Mensajes cifrados de extremo a extremo</span></div>
          </div>
          <div style="background:#f0f2f5; padding:10px; display:flex; align-items:center; gap:8px;">
            <i class="fa-solid fa-plus" style="color:#007bff; font-size:1.2rem;"></i>
            <div style="flex:1; background:#fff; height:38px; border-radius:20px; padding:9px 12px; font-size:14px; color:#aaa;">Mensaje</div>
            <i class="fa-solid fa-microphone" style="color:#008069; font-size:1.2rem;"></i>
          </div>
        </div>
      </div>
    </aside>

  </div>

  <script>
    // --- UI ENGINE ---
    
    function switchView(id, btn) {
      // Nav Active State
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      
      // View Transition
      const views = document.querySelectorAll('.view-section');
      views.forEach(v => {
        v.classList.remove('active');
        if(v.id === 'view-'+id) setTimeout(() => v.classList.add('active'), 50); // Small delay for fade effect
      });
    }

    function showToast(title, icon, color) {
      const container = document.getElementById('toast-area');
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.style.borderLeftColor = color;
      toast.innerHTML = `<i class="${icon}" style="font-size:1.2rem; color:${color}"></i> <div><strong>${title}</strong><br><small style="opacity:0.8">Procesado correctamente</small></div>`;
      container.appendChild(toast);
      
      // Sound Effect (Optional, browser blocks auto-audio often, but good for demo)
      // new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3').play().catch(()=>{});

      setTimeout(() => {
        toast.style.animation = 'fadeOut 0.5s forwards';
        setTimeout(() => toast.remove(), 500);
      }, 3000);
    }

    function getTime() { return new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }
    
    function logSys(txt) { 
      const el = document.getElementById('sys-log'); 
      const line = document.createElement('div');
      line.innerHTML = `> <span style="opacity:0.6">[${getTime()}]</span> ${txt}`;
      el.prepend(line);
    }
    
    function chat(dir, txt) {
      const c = document.getElementById('chat');
      const d = document.createElement('div'); 
      d.className = `msg ${dir}`; 
      
      let checkHtml = dir === 'out' ? `<span class="check-read"><i class="fa-solid fa-check-double"></i></span>` : '';
      d.innerHTML = `${txt}<div class="msg-time">${getTime()} ${checkHtml}</div>`;
      
      c.appendChild(d); 
      c.scrollTop = c.scrollHeight;
    }

    // --- WORKFLOW ENGINE (Based on Document) ---

    const WORKFLOW = [
      { // 0: Intake 
        btn: "Solicitar Esquema",
        title: "Recepci√≥n (Fase 0)", desc: "Paciente solicita cotizaci√≥n. Pedir documentos.",
        run: () => {
          chat("in", "Hola, me recomendaron con ustedes. Quiero cotizar.");
          setTimeout(() => {
            chat("out", "Hola üëã, bienvenido a OncoPro. Para iniciar, por favor env√≠a una foto clara de tu receta m√©dica.");
            showToast("Caso Iniciado", "fa-solid fa-folder-plus", "var(--accent)");
          }, 800);
          logSys("Caso #AQ-2025-001 creado. Estado: NEW");
        }
      },
      { // 1: Extraction 
        btn: "Ejecutar IA (OCR)",
        title: "Extracci√≥n IA (Fase 1)", desc: "Procesar PDF/Foto. Extraer datos y SC.",
        run: () => {
          chat("in", "<i class='fa-solid fa-image' style='color:#0ea5e9'></i> Receta_Dr_Ivan.jpg (Foto)");
          
          const btn = document.getElementById('btn-advance');
          btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> Procesando...`;
          
          setTimeout(() => {
            logSys("OCR Completado: AC-T detectado.");
            logSys("SC Calculada: 1.73m¬≤ (Mosteller)");
            document.getElementById('regimen-lbl').innerText = "AC-T (Doxo+Ciclo)";
            document.getElementById('regimen-lbl').style.background = "var(--success)";
            
            chat("out", "Recibido. Mi sistema est√° analizando tu esquema... dame un momento. ü§ñ");
            showToast("Datos Extra√≠dos", "fa-solid fa-robot", "var(--brand-purple)"); // Purple for AI
            
            // Restore button text is handled by advanceWorkflow next step logic
          }, 1500);
        }
      },
      { // 2: Calculation 
        btn: "Calcular Dosis",
        title: "C√°lculo (Fase 2)", desc: "Separar SAFE (Oncol√≥gicos) e Insumos (AQUA).",
        run: () => {
          logSys("Desglose generado: 2 Viales Doxorrubicina (SAFE) + Insumos (AQUA).");
          showToast("C√°lculo Finalizado", "fa-solid fa-calculator", "var(--accent)");
        }
      },
      { // 3: Quotes 
        btn: "Solicitar a Proveedores",
        title: "Proveedores (Fase 3)", desc: "Enviar Email a SAFE y WA a Almac√©n.",
        run: () => {
          logSys("API Trigger: Enviando solicitudes...");
          chat("out", "Estamos verificando disponibilidad y precios con proveedores... ‚è≥");
          
          // Inject Tracking items
          addTrackItem('track-safe-list', 'paper-plane', 'Solicitud Enviada', 'Email a pedidos@safe.mx', 'var(--accent)');
          addTrackItem('track-aqua-list', 'comment-dots', 'Mensaje WA Enviado', 'Grupo Almac√©n Central', 'var(--warning)');
          
          showToast("Solicitudes Enviadas", "fa-solid fa-paper-plane", "var(--success)");
        }
      },
      { // 4: Consolidate 
        btn: "Generar PDF Cotizaci√≥n",
        title: "Consolidaci√≥n (Fase 4)", desc: "Aplicar 15% Comisi√≥n y generar documento.",
        run: () => {
          logSys("Precios recibidos. Calculando m√°rgenes...");
          
          updateFinance(5000, 1200); // Live Chart Update
          
          // Update tracking to 'received'
          addTrackItem('track-safe-list', 'file-invoice-dollar', 'Cotizaci√≥n Recibida', 'Precios vigentes 48h', 'var(--success)');
          addTrackItem('track-aqua-list', 'box-open', 'Stock Confirmado', 'Reservado Lote #77A', 'var(--success)');
          
          showToast("PDF Generado", "fa-solid fa-file-pdf", "var(--danger)"); // Red for PDF
        }
      },
      { // 5: MD Approval 
        btn: "Solicitar VoBo M√©dico",
        title: "Aprobaci√≥n (Fase 5)", desc: "Enviar a Dr. Iv√°n para validaci√≥n.",
        run: () => {
          logSys("Enviando PDF a Dr. Iv√°n P√©rez...");
          
          // Update Doctor UI
          const badge = document.getElementById('md-status');
          badge.innerText = "APROBADO ‚úÖ";
          badge.style.color = "#fff";
          badge.style.background = "var(--success)";
          
          setTimeout(() => {
            chat("out", "‚úÖ ¬°Buenas noticias! Tu cotizaci√≥n fue aprobada por el Dr. Iv√°n. Te adjunto el detalle.");
            chat("out", "<i class='fa-solid fa-file-pdf' style='color:#ef4444'></i> Cotizacion_Oficial.pdf");
            showToast("Aprobaci√≥n M√©dica", "fa-solid fa-user-doctor", "var(--success)");
          }, 1000);
        }
      },
      { // 6: Patient 
        btn: "Esperar Respuesta",
        title: "Entrega (Fase 6)", desc: "Paciente recibe y acepta.",
        run: () => {
          setTimeout(() => {
            chat("in", "El precio me parece bien. Acepto.");
            logSys("Paciente Acept√≥. Estado: WAITING_PAYMENT");
            showToast("Cliente Acept√≥", "fa-solid fa-thumbs-up", "var(--accent)");
          }, 1500);
        }
      },
      { // 7: Payment 
        btn: "Verificar Pago",
        title: "Pago (Fase 7)", desc: "Validar comprobante SPEI.",
        run: () => {
          chat("in", "<i class='fa-solid fa-image'></i> Comprobante_Banco.jpg");
          logSys("Comprobante recibido. Conciliando con Banco...");
          showToast("Pago Recibido", "fa-solid fa-money-bill-wave", "var(--success)");
        }
      },
      { // 8: Schedule 
        btn: "Agendar Cita",
        title: "Agenda (Fase 8)", desc: "Asignar fecha y cerrar caso.",
        run: () => {
          chat("out", "Pago validado correctamente. Tu cita es el Jueves 9:00 AM. üè•");
          logSys("Caso Cerrado. Estado: SCHEDULED");
          
          // Final Celebration
          confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
          showToast("Caso Completado", "fa-solid fa-flag-checkered", "var(--warning)");
          
          // Disable button
          const btn = document.getElementById('btn-advance');
          btn.disabled = true;
          btn.innerHTML = `Caso Finalizado <i class="fa-solid fa-check"></i>`;
        }
      }
    ];

    let stepIdx = 0;

    function advanceWorkflow() {
      const step = WORKFLOW[stepIdx];
      step.run();

      // Update Visual Track
      document.querySelectorAll('.step').forEach((el, i) => {
        if (i <= stepIdx) el.classList.add('active');
        if (i === stepIdx) el.classList.add('current'); else el.classList.remove('current');
      });
      
      const pct = Math.round(((stepIdx+1)/9)*100);
      document.getElementById('progress-pct').innerText = pct + "%";
      document.getElementById('track-fill').style.width = pct + "%";

      stepIdx++;
      if (stepIdx < WORKFLOW.length) {
        // Small delay to let animations finish before changing text
        setTimeout(() => {
          document.getElementById('act-title').innerText = WORKFLOW[stepIdx].title;
          document.getElementById('act-desc').innerText = WORKFLOW[stepIdx].desc;
          document.getElementById('btn-txt').innerText = WORKFLOW[stepIdx].btn;
        }, 500);
      }
    }

    // --- TRACKING INJECTOR ---
    function addTrackItem(listId, icon, title, desc, color) {
      const div = document.createElement('div');
      div.className = "t-item done";
      div.innerHTML = `
        <div class="t-line"></div>
        <div class="t-icon" style="color:${color}; border-color:${color}; background:rgba(255,255,255,0.05);">
          <i class="fa-solid fa-${icon}"></i>
        </div>
        <div class="t-content">
          <div class="t-meta"><span>${getTime()}</span></div>
          <div style="font-weight:600; font-size:0.9rem; margin-bottom:2px;">${title}</div>
          <div style="font-size:0.8rem; color:var(--text-muted);">${desc}</div>
        </div>
      `;
      document.getElementById(listId).appendChild(div);
    }

    // --- FINANCE UPDATE ---
    function updateFinance(safe, aqua) {
      const comm = safe * 0.15;
      const total = safe + aqua + comm;
      
      // Animate Numbers
      document.getElementById('f-safe').innerText = `$${safe.toLocaleString()}`;
      document.getElementById('f-aqua').innerText = `$${aqua.toLocaleString()}`;
      document.getElementById('f-comm').innerText = `$${comm.toLocaleString()}`;
      document.getElementById('f-total').innerText = `$${total.toLocaleString()}`;
      
      window.finChart.data.datasets[0].data = [safe, aqua, comm];
      window.finChart.update();
    }

    // --- INIT ---
    window.onload = () => {
      const ctx = document.getElementById('finChart').getContext('2d');
      window.finChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['SAFE', 'AQUA', 'Comisi√≥n'],
          datasets: [{ data: [0, 0, 0], backgroundColor: ['#0ea5e9', '#64748b', '#22c55e'], borderWidth: 0 }]
        },
        options: { 
          responsive: true, 
          maintainAspectRatio: false, 
          plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8', padding: 20 } } },
          animation: { animateScale: true, animateRotate: true }
        }
      });
    };

  </script>
</body>
</html>